-- -- 对偏置卷积的偏移量求导
-- drop function if exists sm_sc.fv_d_conv_2d_dloss_dindepdt_3(float[], int[]);
create or replace function sm_sc.fv_d_conv_2d_dloss_dindepdt_3
(
  i_dloss_ddepdt           float[]           ,                          -- 即已求出的损失函数对 y 的导数矩阵
  i_indepdt_var_len        int[]   default array[1, 1]
)
returns float[]
as
$$
declare 
  v_indepdt_var_len        int[] :=  sm_sc.fv_lpad(i_indepdt_var_len, array[1], array_ndims(i_dloss_ddepdt) - array_length(i_indepdt_var_len, 1));
  v_dloss_ddepdt_len       int[] :=  (select array_agg(array_length(i_dloss_ddepdt, a_no) order by a_no) from generate_series(1, array_ndims(i_dloss_ddepdt)) tb_a(a_no));
begin
  return 
    (
      i_dloss_ddepdt 
      |@+| 
      (v_dloss_ddepdt_len / v_indepdt_var_len)
    )
    |><| 
    i_indepdt_var_len
  ;
end
$$
language plpgsql stable
parallel safe
cost 100;
-- -- set search_path to sm_sc;
-- select sm_sc.fv_d_conv_2d_dloss_dindepdt_3
--   (
--     array
--     [
--       [1.0,2.0,3.0,4.0,5.0,6.0,7.0]
--     , [10.0,20.0,30.0,40.0,50.0,60.0,70.0]
--     , [100.0,200.0,300.0,400.0,500.0,600.0,700.0]
--     , [-1.0,-2.0,-3.0,-4.0,-5.0,-6.0,-7.0]
--     , [-10.0,-20.0,-30.0,-40.0,-50.0,-60.0,-70.0]
--     ] :: float[]
--   )

-- select sm_sc.fv_d_conv_2d_dloss_dindepdt_3
--   (
--     array
--     [
--       [
--         [1.0,2.0,3.0,4.0,5.0,6.0,7.0]
--       , [10.0,20.0,30.0,40.0,50.0,60.0,70.0]
--       , [100.0,200.0,300.0,400.0,500.0,600.0,700.0]
--       , [-1.0,-2.0,-3.0,-4.0,-5.0,-6.0,-7.0]
--       , [-10.0,-20.0,-30.0,-40.0,-50.0,-60.0,-70.0]
--       ]
--     , [
--         [1.0,2.0,3.0,4.0,5.0,6.0,7.0]
--       , [10.0,20.0,30.0,40.0,50.0,60.0,70.0]
--       , [100.0,200.0,300.0,400.0,500.0,600.0,700.0]
--       , [-1.0,-2.0,-3.0,-4.0,-5.0,-6.0,-7.0]
--       , [-10.0,-20.0,-30.0,-40.0,-50.0,-60.0,-70.0]
--       ]
--     ]
--   , array[2, 1, 1]
--   )

-- select sm_sc.fv_d_conv_2d_dloss_dindepdt_3
--   (
--     array
--     [
--       [
--         [
--           [1.0,2.0,3.0,4.0,5.0,6.0,7.0]
--         , [10.0,20.0,30.0,40.0,50.0,60.0,70.0]
--         , [100.0,200.0,300.0,400.0,500.0,600.0,700.0]
--         , [-1.0,-2.0,-3.0,-4.0,-5.0,-6.0,-7.0]
--         , [-10.0,-20.0,-30.0,-40.0,-50.0,-60.0,-70.0]
--         ]
--       , [
--           [1.0,2.0,3.0,4.0,5.0,6.0,7.0]
--         , [10.0,20.0,30.0,40.0,50.0,60.0,70.0]
--         , [100.0,200.0,300.0,400.0,500.0,600.0,700.0]
--         , [-1.0,-2.0,-3.0,-4.0,-5.0,-6.0,-7.0]
--         , [-10.0,-20.0,-30.0,-40.0,-50.0,-60.0,-70.0]
--         ]
--       ]
--     , [
--         [
--           [1.0,2.0,3.0,4.0,5.0,6.0,7.0]
--         , [10.0,20.0,30.0,40.0,50.0,60.0,70.0]
--         , [100.0,200.0,300.0,400.0,500.0,600.0,700.0]
--         , [-1.0,-2.0,-3.0,-4.0,-5.0,-6.0,-7.0]
--         , [-10.0,-20.0,-30.0,-40.0,-50.0,-60.0,-70.0]
--         ]
--       , [
--           [1.0,2.0,3.0,4.0,5.0,6.0,7.0]
--         , [10.0,20.0,30.0,40.0,50.0,60.0,70.0]
--         , [100.0,200.0,300.0,400.0,500.0,600.0,700.0]
--         , [-1.0,-2.0,-3.0,-4.0,-5.0,-6.0,-7.0]
--         , [-10.0,-20.0,-30.0,-40.0,-50.0,-60.0,-70.0]
--         ]
--       ]
--     ]
--   , array[2, 2, 1, 1]
--   )